name: Deployment on Production

on:
  push:
    branches:
      - main

jobs:
  stage-deployment:
    name: Production deployment
    runs-on: ubuntu-latest
    environment: av-production
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@2.22.0
        with:
          php-version: 8.2

      - name: Install dependencies
        run: |
          APP_ENV=prod composer install --no-dev --prefer-dist --no-progress --ansi

      - name: Overwrite production env file
        uses: DamianReeves/write-file-action@master
        with:
          path: .env
          write-mode: overwrite
          contents: |
            # generated by github-action workflow
            APP_ENV=prod
            APP_SECRET=${{ secrets.APP_SECRET }}
            APP_MAINTENANCE_MODE=${{ secrets.APP_MAINTENANCE_MODE }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}

      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          dry-run: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/docs
            **/tools/**
            **/var/**

            .env.altervista*
            fileToExclude.txt

      - name: Cache clear on emote server
        uses: wei/curl@master
        with:
          args: --insecure -I https://medicaljob.altervista.org/command/cache/clear
